
{
  "entities": {
    "Image": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Image",
      "type": "object",
      "description": "Represents an uploaded image and its associated data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the image entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who uploaded the image. (Relationship: User 1:N Image)"
        },
        "storagePath": {
          "type": "string",
          "description": "The path to the image in Firebase Storage."
        },
        "directUrl": {
          "type": "string",
          "description": "Direct URL for accessing the image.",
          "format": "uri"
        },
        "bbCode": {
          "type": "string",
          "description": "BBCode representation of the image."
        },
        "htmlCode": {
          "type": "string",
          "description": "HTML code representation of the image."
        },
        "uploadTimestamp": {
          "type": "string",
          "description": "Timestamp of when the image was uploaded.",
          "format": "date-time"
        },
        "originalName": {
          "type": "string",
          "description": "The original name of the file when uploaded."
        },
        "fileSize": {
          "type": "number",
          "description": "Size of the uploaded file in bytes."
        },
        "mimeType": {
          "type": "string",
          "description": "MIME type of the uploaded image (e.g., image/jpeg, image/png)."
        },
        "likeCount": {
          "type": "number",
          "description": "Number of likes the image has received."
        }
      },
      "required": [
        "id",
        "userId",
        "directUrl",
        "bbCode",
        "htmlCode",
        "uploadTimestamp",
        "likeCount"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the image uploading application.  Note: Authentication details (passwords, etc.) are handled by Firebase Auth and are NOT stored in this entity.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "Display name of the user."
        },
        "creationTimestamp": {
          "type": "string",
          "description": "Timestamp of when the user account was created.",
          "format": "date-time"
        },
        "ticketCount": {
          "type": "number",
          "description": "Number of remaining upload tickets for the user."
        },
        "lastTicketRefill": {
          "type": "string",
          "description": "Timestamp of the last time the user's tickets were refilled.",
          "format": "date-time"
        },
        "emailNotifications": {
          "type": "boolean",
          "description": "Indicates if the user has opted-in to receive email notifications."
        },
        "bio": {
          "type": "string",
          "description": "A short biography or description of the user."
        },
        "websiteUrl": {
          "type": "string",
          "description": "URL to the user's personal website.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "email",
        "displayName",
        "creationTimestamp",
        "ticketCount",
        "lastTicketRefill"
      ]
    },
     "Note": {
      "title": "Note",
      "type": "object",
      "description": "Represents a simple text note created by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the note."
        },
        "userId": {
          "type": "string",
          "description": "ID of the user who created the note."
        },
        "text": {
          "type": "string",
          "description": "The content of the note."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the note was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "text",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. The 'userId' parameter represents the unique identifier for the user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/images/{imageId}",
        "definition": {
          "entityName": "Image",
          "schema": {
            "$ref": "#/backend/entities/Image"
          },
          "description": "Stores image data associated with a specific user. Path-based ownership is enforced, granting access only to the user who owns the images. The 'userId' parameter identifies the user, and the 'imageId' parameter is the unique identifier for the image.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "imageId",
              "description": "The unique identifier of the image."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/notes/{noteId}",
        "definition": {
          "entityName": "Note",
          "schema": {
            "$ref": "#/backend/entities/Note"
          },
          "description": "Stores simple text notes for a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "noteId",
              "description": "The unique identifier of the note."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{adminId}",
        "definition": {
          "entityName": "adminRole",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection represent users with administrator privileges.  The mere existence of a document with a matching uid grants admin access.",
          "params": [
            {
              "name": "adminId",
              "description": "The unique identifier of the admin user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to provide a secure and scalable solution for the image uploading application, aligning with the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). \n\nTo ensure Authorization Independence (Strategy A), the structure uses path-based ownership for images. Images are stored as subcollections of user documents (`/users/{userId}/images/{imageId}`), implicitly granting ownership to the user identified by `{userId}`. No denormalization is needed here, as path-based ownership inherently provides authorization context without requiring `get()` calls in the security rules.\n\nStructural Segregation (Strategy B) is applied by storing all images belonging to a user in the same subcollection. This ensures a homogenous security posture, as all documents within `/users/{userId}/images` share the same security requirements (owned by the user).\n\nAccess Modeling (Strategy C) leverages path-based ownership, a standard and consistent pattern for private data. This simplifies security rules, making them more robust and easier to debug. Since no roles or membership maps are required, this eliminates potential complexities in managing authorization.\n\nThe design supports the required QAPs (Rules are not Filters) by using path-based ownership. Listing images is inherently scoped to a user's images, which can be secured using rules that only allow the user associated with the `/users/{userId}` path to list images under that path. This avoids the need to filter results based on user ID, ensuring efficient and secure list operations. It also allows a simple admin role to be implemented via a separate collection like `/roles_admin/{adminId}`.\n"
  }
}
