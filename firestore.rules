/**
 * @fileoverview Firestore Security Rules for the image uploading application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and uploaded images.
 * Only authenticated users can create, update, or delete their own profiles and images.
 * Additionally, it supports admin users who have read/write access to all the data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.  Only the user with the matching {userId}
 *   can read and write their profile data.
 * - /users/{userId}/images/{imageId}: Stores image data associated with a specific user.
 *   Only the user with the matching {userId} can manage images under their profile.
 * - /roles_admin/{adminId}: Documents in this collection represent admin users.
 *   The existence of a document in this collection grants admin privileges to the user.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied.
 * - Path-based ownership is enforced for images, simplifying security rules.
 * - The 'id' field in both User and Image entities is validated to match the document ID
 *   on creation and is immutable on update to maintain relational integrity.
 * - Admin privileges are granted based on the presence of a document in the `/roles_admin` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Authentication is required for most operations.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource, based on the provided userId.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Enforces ownership-based access control.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource, and that the resource already exists.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Enforces ownership-based access control and prevents changes to non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is an admin.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Checks admin privileges based on document existence in the /roles_admin collection.
     */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    match /users/{userId} {
      /**
       * @description Manages user profile data.
       * @path /users/{userId}
       * @allow (create) - User with matching UID can create their profile.
       * @allow (get) - User with matching UID can get their profile.
       * @allow (update) - User with matching UID can update their profile.
       * @allow (delete) - User with matching UID can delete their profile.
       * @deny (create) - User tries to create a profile with an ID that doesn't match their UID.
       * @deny (list) - Listing users is not allowed.
       * @principle Enforces document ownership for reads and writes.
       */
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/images/{imageId} {
      /**
       * @description Manages image data for a specific user.
       * @path /users/{userId}/images/{imageId}
       * @allow (create) - User with matching UID can create an image under their profile.
       * @allow (get) - User with matching UID can get an image under their profile.
       * @allow (update) - User with matching UID can update an image under their profile.
       * @allow (delete) - User with matching UID can delete an image under their profile.
       * @deny (create) - User tries to create an image under a profile that doesn't match their UID.
       * @deny (list) - Listing images for a different user is not allowed.
       * @principle Enforces document ownership for reads and writes within a user's image subcollection.
       */
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == imageId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

      match /roles_admin/{adminId} {
      /**
       * @description Manages admin role assignment.
       * @path /roles_admin/{adminId}
       * @allow (get) - Only admins can get documents in this collection.
       * @allow (list) - Listing admins is not allowed.
       * @allow (create) - Only admins can create documents in this collection.
       * @allow (update) - Only admins can update documents in this collection.
       * @allow (delete) - Only admins can delete documents in this collection.
       * @deny (create) - Non-admins cannot create documents in this collection.
       * @deny (delete) - Non-admins cannot delete documents in this collection.
       * @principle Restricts access to admin role management to existing admins.
       */
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}